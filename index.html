<!doctype html>

<html>

  <head>
    <meta charset="utf-8">
    <title>Simple logging example</title>
    <style>
      .comment {
          color: #888888
      }
    </style>
  </head>

  <body>
    <script>
      var output = "";
      var memory = new WebAssembly.Memory({initial: 4});
      var importObject = {
          js: {
              memory: memory,
              table : new WebAssembly.Table(
                  {initial: 256, element: "anyfunc"}),
          },
          console: {
              log: function(arg) {
                  console.log(arg);
              },
              logstr: function(arg) {
                  console.log(getString(arg));
              },
          },
          io: {
              printlnString: function(arg) {
                  document.getElementById("console").innerText +=
                      getString(arg) + "\n";
              },
              outputString: function(arg) {
                  output = getString(arg);
                  writeToConsole(output);
              },
          },
      };

      function getString(address) {
          var i8 = new Uint8Array(memory.buffer);
          var start = address, end = address;
          while (i8[end] != 0) { end++; }
          var bytes = new Uint8Array(memory.buffer, start, end - start);
          return new TextDecoder('utf8').decode(bytes);
      }

      function htmlEscape(str) {
          return str
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/\n/g, "<br />");
      }
      function writeToConsole(str) {
          var first = true;
          var lines = str.split('\n')
          for (var i in lines) {
              var line = lines[i];
              var comp = line.indexOf(";");
              var com = (comp < 0) ? "" : line.substr(comp);
              var out = ""
              if (first) {
                  first = false;
              } else {
                  out += "<br />";
              }
              out += htmlEscape(
                  line.substr(0, (comp < 0) ? line.length : comp - 1));
              if (com.length > 0) {
                  out += "<span class='comment'>" + htmlEscape(com) + "</span>";
              }
              document.getElementById("console").innerHTML += out;
          }
      }

      var ichigo = null;
      var input_address = 51200;
      function storeString(str) {
          var i8 = new Uint8Array(memory.buffer);
          var str_array = new TextEncoder('utf8').encode(str);
          for (var i = 0; i < str_array.length; i++) {
              i8[input_address + i] = str_array[i];
          }
          i8[input_address + str_array.length] = 0;
      }
      function runEval() {
          var str = document.getElementById("input").value;
          writeToConsole("> " + str + "\n");
          document.getElementById("input").value = "";

          storeString(str);
          console.log("Input: " + getString(input_address));
          output = "";
          ichigo.instance.exports.readAndEval();
          writeToConsole("\n");
      }
      function runRead() {
          var str = document.getElementById("input").value;
          writeToConsole("(read only)> " + str + "\n");
          document.getElementById("input").value = "";

          storeString(str);
          console.log("Input: " + getString(input_address));
          output = "";
          ichigo.instance.exports.read();
          writeToConsole("\n");
      }
      var test_data = [
          ["nil", "NIL"],
          ["t", "*T*"],
          ["f", "NIL"],
          ["1", "1"],
          ["'a", "A"],
          ["'very-long-name", "VERY-LONG-NAME"],
          ["(car '(a b c))", "A"],
          ["(cdr '(a b c))", "(B C)"],
          ["(cons 'a 'b)", "(A . B)"],
          ["(cons (cdr '(a b c)) (car '(a b c)))", "((B C) . A)"],
          ["(atom (car '(a b c)))", "*T*"],
          ["(atom (cons 1 2))", "NIL"],
          ["(eq 'a 'a)", "*T*"],
          ["(eq 'a 'b)", "NIL"],
          ["(eq (cons 1 2) (cons 1 2))", "NIL"],
          ["(equal 1 1)", "*T*"],
          ["(equal 1 2)", "NIL"],
          ["(equal (cons 1 2) (cons 1 2))", "*T*"],
          ["(equal (cons 1 2) (cons 1 3))", "NIL"],
          ["(equal (cons 1 (cons 2 3)) (cons 1 (cons 2 3)))", "*T*"],
          ["(list)", "NIL"],
          ["(list (car '(a b c)))", "(A)"],
          ["(list 1 2 3 4 5)", "(1 2 3 4 5)"],
          ["(if nil 1 2)", "2"],
          ["(if t 1 2)", "1"],
          ["(if (atom (cons 1 2)) (car '(a b)) (cdr '(a b)))", "(B)"],
          ["(if (eq 1 1) (car '(a b)) (cdr '(a b)))", "A"],
          ["((lambda(x) x) 1)", "1"],
          ["((lambda(x y) (cons y x)) 1 2)", "(2 . 1)"],
          ["((lambda(x) ((lambda(y) (cons x y)) 2)) 1)", "(1 . 2)"],
          ["((lambda(f) (f 1)) '(lambda (x) (cons x x)))", "(1 . 1)"],
          ["((lambda(f)(f 1 2)) 'cons)", "(1 . 2)"],
          ["(define '((kaar (lambda(x) (car (car x))))" +
           "(kadr (lambda(x) (car (cdr x))))))", "(KAAR KADR)"],
          ["(kaar '((a b) (c d)))", "A"],
          ["(kadr '((a b) (c d)))", "(C D)"],
          ["(+)", "0"],
          ["(+ 1)", "1"],
          ["(+ 1 2 3)", "6"],
          ["(define '((add-from-0-to-n (lambda(n)(if (eq n 0) 0 " +
           "(+ n (add-from-0-to-n (+ n -1)))))))))", "(ADD-FROM-0-TO-N)"],
          ["(add-from-0-to-n 10)", "55"],

          ["", /R4/],
          ["(", /R4/],
          ["((", /R4/],
          ["(a b .", /R4/],
          ["))))", /R1/],
          ["(a .)", /R1/],
          ["(a . b c)", /R1/],
          ["ub", /A8/],
          ["(cons 1 ub)", /A8/],
          ["(if ub 1 2)", /A8/],
          ["(if t ub 2)", /A8/],
          ["(if f ub 2)", "2"],
          ["(list 1 2 3 4 5 ub 6)", /A8/],
          ["(+ 1 2 3 4 5 ub 6)", /A8/],
          ["(1 2)", /A2/],
          ["(ub 2)", /A2/],
          ["((lambda(a)(a 1)) 'a)", /A2/],
          ["(car 'a)", /P1/],
      ];
      function runTest() {
          var num_pass = 0, num_fail = 0;
          for (i in test_data) {
              var str = test_data[i][0];
              writeToConsole("> " + str + "\n");
              storeString(str);
              output = "";
              ichigo.instance.exports.readAndEval();

              var pass = false;
              if (test_data[i][1] instanceof RegExp) {
                  pass = test_data[i][1].test(output);
              } else {
                  pass = (test_data[i][1] == output);
              }

              if (pass) {
                  writeToConsole("  ;; OK" + "\n");
                  num_pass++;
              } else {
                  writeToConsole("  ;; Failed" + "\n" +
                                 ";; Expected: " + test_data[i][1] + "\n" +
                                 ";; Actual: " + output + "\n");
                  num_fail++;
              }
          }
          document.getElementById("msg").innerText = "pass: " + num_pass +
              "  fail: " + num_fail
      }

      WebAssembly.instantiateStreaming(fetch('ichigo.wasm'), importObject)
    .then(obj => {
        ichigo = obj;
        ichigo.instance.exports.init();
    });
    </script>
    <input type="text" id="input"></input>
    <input type="button" value="eval" onClick="runEval()"></input>
    <input type="button" value="read" onClick="runRead()"></input>
    <input type="button" value="test" onClick="runTest()"></input>
    <div id="msg" style="color:#0000ff">
    </div>
    <div id="console">
    </div>
  </body>

  </html>
