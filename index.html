<!doctype html>

<html>

  <head>
    <meta charset="utf-8">
    <title>Simple logging example</title>
  </head>

  <body>
    <script>
      var output = "";
      var memory = new WebAssembly.Memory({initial: 3});
      var importObject = {
          js: {
              memory: memory,
              table : new WebAssembly.Table(
                  {initial: 256, element: "anyfunc"}),
          },
          console: {
              log: function(arg) {
                  console.log(arg);
              },
              logstr: function(arg) {
                  console.log(getString(arg));
              },
          },
          io: {
              printlnString: function(arg) {
                  document.getElementById("console").innerText +=
                      getString(arg) + "\n";
              },
              outputString: function(arg) {
                  output += getString(arg);
              },
          },
      };

      function getString(address) {
          var i8 = new Uint8Array(memory.buffer);
          var start = address, end = address;
          while (i8[end] != 0) { end++; }
          var bytes = new Uint8Array(memory.buffer, start, end - start);
          return new TextDecoder('utf8').decode(bytes);
      }

      var ichigo = null;
      var input_address = 51200;
      function storeString(str) {
          var i8 = new Uint8Array(memory.buffer);
          var str_array = new TextEncoder('utf8').encode(str);
          for (var i = 0; i < str_array.length; i++) {
              i8[input_address + i] = str_array[i];
          }
          i8[input_address + str_array.length] = 0;
      }
      function runEval() {
          var str = document.getElementById("input").value;
          document.getElementById("console").innerText +=
              "> " + str + "\n";
          document.getElementById("input").value = "";

          storeString(str);
          console.log("Input: " + getString(input_address));
          output = "";
          ichigo.instance.exports.readAndEval();
          document.getElementById("console").innerText += output + "\n";
      }
      function runRead() {
          var str = document.getElementById("input").value;
          document.getElementById("console").innerText +=
              "(read only)> " + str + "\n";
          document.getElementById("input").value = "";

          storeString(str);
          console.log("Input: " + getString(input_address));
          output = "";
          ichigo.instance.exports.read();
          document.getElementById("console").innerText += output + "\n";
      }
      var test_data = [
          ["nil", "NIL"],
          ["t", "*T*"],
          ["f", "NIL"],
          ["1", "1"],
          ["'a", "A"],
          ["'very-long-name", "VERY-LONG-NAME"],
          ["(car '(a b c))", "A"],
          ["(cdr '(a b c))", "(B C)"],
          ["(cons 'a 'b)", "(A . B)"],
          ["(cons (cdr '(a b c)) (car '(a b c)))", "((B C) . A)"],
          ["(atom (car '(a b c)))", "*T*"],
          ["(atom (cons 1 2))", "NIL"],
          ["(eq 'a 'a)", "*T*"],
          ["(eq 'a 'b)", "NIL"],
          ["(eq (cons 1 2) (cons 1 2))", "NIL"],
          ["(equal 1 1)", "*T*"],
          ["(equal 1 2)", "NIL"],
          ["(equal (cons 1 2) (cons 1 2))", "*T*"],
          ["(equal (cons 1 2) (cons 1 3))", "NIL"],
          ["(equal (cons 1 (cons 2 3)) (cons 1 (cons 2 3)))", "*T*"],
          ["(list)", "NIL"],
          ["(list (car '(a b c)))", "(A)"],
          ["(list 1 2 3 4 5)", "(1 2 3 4 5)"],
          ["(if nil 1 2)", "2"],
          ["(if t 1 2)", "1"],
          ["(if (atom (cons 1 2)) (car '(a b)) (cdr '(a b)))", "(B)"],
          ["(if (eq 1 1) (car '(a b)) (cdr '(a b)))", "A"],

          ["", /R4/],
          ["(", /R4/],
          ["((", /R4/],
          ["(a b .", /R4/],
          ["))))", /R1/],
          ["(a .)", /R1/],
          ["(a . b c)", /R1/],
      ];
      function runTest() {
          var num_pass = 0, num_fail = 0;
          for (i in test_data) {
              var str = test_data[i][0];
              var c = document.getElementById("console");
              c.innerText += "> " + str + "\n";
              storeString(str);
              output = "";
              ichigo.instance.exports.readAndEval();
              c.innerText += output;

              var pass = false;
              if (test_data[i][1] instanceof RegExp) {
                  pass = test_data[i][1].test(output);
              } else {
                  pass = (test_data[i][1] == output);
              }

              if (pass) {
                  c.innerText += "  ;; OK" + "\n";
                  num_pass++;
              } else {
                  c.innerText += "  ;; Failed" + "\n" +
                      ";; Expected: " + test_data[i][1] + "\n" +
                      ";; Actual: " + output + "\n";
                  num_fail++;
              }
          }
          document.getElementById("msg").innerText = "pass: " + num_pass +
              "  fail: " + num_fail
      }

      WebAssembly.instantiateStreaming(fetch('ichigo.wasm'), importObject)
    .then(obj => {
        ichigo = obj;
        ichigo.instance.exports.init();
    });
    </script>
    <input type="text" id="input"></input>
    <input type="button" value="eval" onClick="runEval()"></input>
    <input type="button" value="read" onClick="runRead()"></input>
    <input type="button" value="test" onClick="runTest()"></input>
    <div id="msg" style="color:#0000ff">
    </div>
    <div id="console">
    </div>
  </body>

  </html>
